<!DOCTYPE html>
<html>
<head>
    <title>OpenClaw Dow 1m Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { 
            background: #131722; 
            margin: 0; 
            padding: 20px; 
            color: #d1d4dc; 
            font-family: sans-serif; 
            overflow: hidden;
        }
        #chart { 
            width: 100%; 
            height: 85vh; 
            border: 1px solid #2B2B43; 
        }
        h2 { margin-top: 0; }
    </style>
</head>
<body>
    <h2>YM=F 1-Minute Accumulation Skill</h2>
    <div id="chart"></div>

    <script>
        // 1. Initialize Chart
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            layout: { 
                background: { type: 'solid', color: '#131722' },
                textColor: '#d1d4dc' 
            },
            grid: { 
                vertLines: { color: '#2B2B43' }, 
                horzLines: { color: '#2B2B43' } 
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
            },
        });

        // 2. Add Candlestick Series (v4.x Syntax)
        const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#26a69a', 
            downColor: '#ef5350', 
            borderVisible: false, 
            wickVisible: true 
        });

        // 3. Data Fetching Function
        function loadData() {
            console.log("Fetching new data from /api/data/DOW...");
            
            fetch('/api/data/DOW') 
                .then(res => {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.json();
                })
                .then(data => {
                    console.log("Data successfully received:", data);
                    
                    if(data.candles && data.candles.length > 0) {
                        // Update candles
                        candleSeries.setData(data.candles);
                        
                        // Update accumulation markers
                        if (data.markers) {
                            candleSeries.setMarkers(data.markers);
                        }
                        
                        // Auto-zoom to show all data points
                        chart.timeScale().fitContent(); 
                        console.log("Chart rendered with " + data.candles.length + " candles.");
                    } else {
                        console.warn("Received empty candle data.");
                    }
                })
                .catch(err => console.error("Frontend Fetch Error:", err));
        }

        // 4. Initial load and interval
        loadData();
        setInterval(loadData, 60000); // Refresh every minute

        // 5. Responsive Resize
        window.addEventListener('resize', () => {
            chart.applyOptions({ 
                width: document.getElementById('chart').clientWidth,
                height: document.getElementById('chart').clientHeight
            });
        });
    </script>
</body>
</html>
