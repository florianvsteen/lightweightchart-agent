<!DOCTYPE html>
<html>
<head>
    <title>US30 - 1 Minute Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { 
            background: #131722; 
            margin: 0; 
            padding: 20px; 
            color: #d1d4dc; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        #chart-container {
            position: relative;
            width: 100%;
            height: 85vh;
        }
        #chart { 
            width: 100%; 
            height: 100%; 
            border: 1px solid #2B2B43; 
        }
        #countdown {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 24, 35, 0.85);
            padding: 8px 15px;
            border: 1px solid #2962ff;
            border-radius: 4px;
            font-family: monospace;
            font-size: 1.1rem;
            color: #2962ff;
            z-index: 10;
            pointer-events: none;
        }
        h2 { margin-top: 0; font-weight: 300; color: #fff; }
        .status { font-size: 0.8rem; color: #00ffcc; margin-left: 10px; vertical-align: middle; }
    </style>
</head>
<body>
    <h2>Dow Jones Industrial Average <span class="status" id="status">● Live</span></h2>
    
    <div id="chart-container">
        <div id="countdown">Next Candle: --s</div>
        <div id="chart"></div>
    </div>

    <script>
        // 1. Initialize Chart with v4+ Options
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            layout: {
                background: { type: 'solid', color: '#131722' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#2B2B43' },
                horzLines: { color: '#2B2B43' },
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
                barSpacing: 10,
            },
        });

        // 2. Create Candlestick Series using the new v4 constructor
        const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#26a69a', 
            downColor: '#ef5350', 
            borderVisible: false, 
            wickVisible: true 
        });

        // 3. Countdown Logic (Updates every 1 second)
        function updateCountdown() {
            const now = new Date();
            const secondsLeft = 60 - now.getSeconds();
            document.getElementById('countdown').innerText = `Next Candle: ${secondsLeft}s`;
            
            // Subtle visual feedback: change color when close to close
            const color = secondsLeft <= 10 ? '#ef5350' : '#2962ff';
            document.getElementById('countdown').style.borderColor = color;
            document.getElementById('countdown').style.color = color;
        }

        // 4. Data Fetching Logic (Updates every 30 seconds)
        function loadData() {
            const statusEl = document.getElementById('status');
            statusEl.style.opacity = "0.5"; // Blink effect on fetch

            fetch('/api/data/DOW')
                .then(res => res.json())
                .then(data => {
                    statusEl.style.opacity = "1";
                    if (data.candles && data.candles.length > 0) {
                        candleSeries.setData(data.candles);
                        if (data.markers) {
                            candleSeries.setMarkers(data.markers);
                        }
                        // Fit content only on first load so we don't mess with user's zoom
                        if (!window.initialLoadDone) {
                            chart.timeScale().fitContent();
                            window.initialLoadDone = true;
                        }
                    }
                })
                .catch(err => {
                    console.error("Fetch error:", err);
                    statusEl.innerText = "● Error";
                    statusEl.style.color = "red";
                });
        }

        // 5. Setup Timers
        setInterval(updateCountdown, 1000); // Visual clock
        setInterval(loadData, 30000);      // Data refresh (30s)

        // 6. Handle Resizing
        window.addEventListener('resize', () => {
            chart.applyOptions({ 
                width: document.getElementById('chart').clientWidth 
            });
        });

        // Initial Run
        updateCountdown();
        loadData();
    </script>
</body>
</html>
