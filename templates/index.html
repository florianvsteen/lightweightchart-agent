<!DOCTYPE html>
<html>
<head>
    <title>US30 - 1 Minute Real-Time Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background: #131722; margin: 0; padding: 20px; color: #d1d4dc; font-family: sans-serif; overflow: hidden; }
        #chart-container { position: relative; width: 100%; height: 90vh; }
        #chart { width: 100%; height: 100%; }
        h2 { margin-top: 0; color: #d1d4dc; font-weight: 400; }
        .status-bar { font-size: 12px; color: #848e9c; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>Dow Jones Industrial Average (US30)</h2>
    <div class="status-bar" id="status">Connecting to real-time stream...</div>
    <div id="chart-container">
        <div id="chart"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chart = LightweightCharts.createChart(document.getElementById('chart'), {
                layout: { 
                    background: { type: 'solid', color: '#131722' }, 
                    textColor: '#d1d4dc',
                },
                grid: { 
                    vertLines: { color: '#2B2B43' }, 
                    horzLines: { color: '#2B2B43' } 
                },
                timeScale: { 
                    timeVisible: true, 
                    secondsVisible: false,
                },
            });

            const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#26a69a', 
                downColor: '#ef5350', 
                borderVisible: false, 
                wickVisible: true 
            });

            const livePriceLine = candleSeries.createPriceLine({
                price: 0,
                color: '#26a69a',
                lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Dotted,
                axisLabelVisible: true,
                title: 'LIVE',
            });

            let isInitial = false;

            function loadData() {
                fetch('/api/data/DOW')
                    .then(res => res.json())
                    .then(data => {
                        if(data.candles && data.candles.length > 0) {
                            // Set historical data
                            candleSeries.setData(data.candles);
                            
                            if (data.markers) {
                                candleSeries.createMarkers(data.markers);
                            }

                            // UPDATE: Apply the live OHLC packet from the scraper
                            if (data.live && data.live.time) {
                                candleSeries.update({
                                    time: data.live.time,
                                    open: data.live.open,
                                    high: data.live.high,
                                    low: data.live.low,
                                    close: data.live.close
                                });

                                // Update the Price Line on the right axis
                                livePriceLine.applyOptions({
                                    price: data.live.close,
                                    color: data.live.close >= data.live.open ? '#26a69a' : '#ef5350',
                                    title: `US30: ${data.live.close.toFixed(2)}`
                                });
                                
                                document.getElementById('status').innerText = `Live Feed Active - Last Tick: ${data.live.close}`;
                            }

                            if(!isInitial) { 
                                chart.timeScale().fitContent(); 
                                isInitial = true; 
                            }
                        }
                    })
                    .catch(err => console.error("Data fetch error:", err));
            }

            // Polling every 1 second ensures the "Live" object in Flask 
            // (which is updated by the scraper) is pushed to the chart immediately.
            setInterval(loadData, 1000);

            window.onresize = () => {
                chart.applyOptions({ 
                    width: document.getElementById('chart').clientWidth,
                    height: document.getElementById('chart').clientHeight 
                });
            };
        });
    </script>
</body>
</html>
