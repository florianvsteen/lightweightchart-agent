<!DOCTYPE html>
<html>
<head>
    <title>US30 Accumulation Agent</title>
    <script src="https://unpkg.com/lightweight-charts@4.2.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background: #131722; margin: 0; padding: 20px; color: #d1d4dc; font-family: sans-serif; }
        #chart-container { width: 100%; height: 85vh; border: 1px solid #2B2B43; }
        #chart { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <h2 style="margin: 0 0 10px 0;">US30 Minute Analysis</h2>
    <div id="chart-container"><div id="chart"></div></div>

    <script>
        const container = document.getElementById('chart');
        const chart = LightweightCharts.createChart(container, {
            layout: { background: { color: '#131722' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#1f222d' }, horzLines: { color: '#1f222d' } },
            timeScale: { timeVisible: true, borderColor: '#2B2B43' },
        });

        const candleSeries = chart.addCandlestickSeries({
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickVisible: true 
        });

        // The "Box" series
        const boxSeries = chart.addBaselineSeries({
            baseValue: { type: 'price', price: 0 },
            topFillColor1: 'rgba(255, 255, 255, 0.1)',
            topFillColor2: 'rgba(255, 255, 255, 0.1)',
            topLineColor: 'rgba(255, 255, 255, 0.5)',
            bottomFillColor1: 'rgba(0,0,0,0)',
            bottomFillColor2: 'rgba(0,0,0,0)',
            bottomLineColor: 'rgba(255, 255, 255, 0.5)',
            lineWidth: 1,
        });

        function loadData() {
            fetch('/api/data/DOW')
                .then(res => res.json())
                .then(data => {
                    if(!data.candles) return;
                    candleSeries.setData(data.candles);

                    if (data.accumulation) {
                        const zone = data.accumulation;
                        
                        // Update the box series style to float at the accumulation level
                        boxSeries.applyOptions({
                            baseValue: { type: 'price', price: zone.bottom }
                        });

                        // Create the rectangle data
                        const boxData = [
                            { time: zone.start, value: zone.top },
                            { time: zone.end, value: zone.top }
                        ];
                        boxSeries.setData(boxData);
                    } else {
                        boxSeries.setData([]);
                    }
                });
        }

        setInterval(loadData, 2000);
    </script>
</body>
</html>
